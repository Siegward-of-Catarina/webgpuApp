(()=>{"use strict";class e{constructor(e,t){const i=GPUBufferUsage.INDEX|GPUBufferUsage.COPY_DST,r={size:t.byteLength,usage:i,mappedAtCreation:!0};this.buffer=e.createBuffer(r),new Uint32Array(this.buffer.getMappedRange()).set(t),this.buffer.unmap()}}class t{constructor(e,t){const i=GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST,r={size:t.byteLength,usage:i,mappedAtCreation:!0};this.buffer=e.createBuffer(r),new Float32Array(this.buffer.getMappedRange()).set(t),this.buffer.unmap()}}const i=e=>{if(null===e)throw Error(e+"is null")};class r{constructor(){this._vertexBuffer=null,this._indexBuffer=null,this._indexCount=null,this._indexFormat="uint32"}get vertexBuffer(){return i(this._vertexBuffer),this._vertexBuffer.buffer}get indexBuffer(){return i(this._indexBuffer),this._indexBuffer.buffer}get indexCount(){return i(this._indexCount),this._indexCount}get indexFormat(){return this._indexFormat}}class n extends r{constructor(i){super();const r=new Float32Array([-.5,.5,0,0,0,-.5,-.5,0,0,1,.5,.5,0,1,0,.5,-.5,0,1,1]);this._vertexBuffer=new t(i,r);const n=new Uint32Array([0,1,2,2,1,3]);this._indexCount=n.length,this._indexBuffer=new e(i,n)}}class s{constructor(){this._module=null,this._bufferLayout=null,this._entryPoint={Vertex:"vs_main",Fragment:"fs_main"}}get module(){return i(this._module),this._module}get bufferLayout(){return i(this._bufferLayout),this._bufferLayout}get entryPoint(){return this._entryPoint}}class a extends s{constructor(e){super(),this._module=e.createShaderModule({code:"struct TransformData{\r\n  model: mat4x4<f32>,\r\n  view: mat4x4<f32>,\r\n  projection: mat4x4<f32>\r\n};\r\n\r\n@binding(0) @group(0) var <uniform> transformUBO : TransformData;\r\n@binding(1) @group(0) var myTextyre: texture_2d<f32>;\r\n@binding(2) @group(0) var mySampler: sampler;\r\n\r\nstruct Output {\r\n    @builtin(position) Position : vec4<f32>,\r\n    @location(0) TexCoord : vec2<f32>,\r\n};\r\n\r\n@vertex\r\nfn vs_main(@location(0) vertexPosition: vec3<f32>, @location(1) vertexTexCoord: vec2<f32> ) -> Output {\r\n\r\n\r\n\r\n    var output : Output;\r\n    var mvpMat = transformUBO.projection * transformUBO.view * transformUBO.model;\r\n    output.Position = mvpMat * vec4<f32>(vertexPosition, 1.0);\r\n    output.TexCoord = vertexTexCoord;\r\n\r\n    return output;\r\n}\r\n\r\n@fragment\r\nfn fs_main(@location(0) TexCoord: vec2<f32>) -> @location(0) vec4<f32> {\r\n    return textureSample(myTextyre, mySampler, TexCoord);\r\n}"}),this._bufferLayout={arrayStride:20,attributes:[{shaderLocation:0,format:"float32x3",offset:0},{shaderLocation:1,format:"float32x2",offset:12}]}}}var o=1e-6,u="undefined"!=typeof Float32Array?Float32Array:Array;function h(){var e=new u(16);return u!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0),e[0]=1,e[5]=1,e[10]=1,e[15]=1,e}Math.random,Math.PI,Math.hypot||(Math.hypot=function(){for(var e=0,t=arguments.length;t--;)e+=arguments[t]*arguments[t];return Math.sqrt(e)});var f=function(e,t,i,r){return new(i||(i=Promise))((function(n,s){function a(e){try{u(r.next(e))}catch(e){s(e)}}function o(e){try{u(r.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(a,o)}u((r=r.apply(e,t||[])).next())}))};class c{constructor(){this.initialize=(e,t)=>f(this,void 0,void 0,(function*(){const i=yield fetch(t),r=yield i.blob(),n=yield createImageBitmap(r);yield this.loadImageBitmap(e,n),this.view=this.texture.createView({format:"bgra8unorm",dimension:"2d",aspect:"all",baseMipLevel:0,mipLevelCount:1,baseArrayLayer:0,arrayLayerCount:1}),this.sampler=e.createSampler({addressModeU:"repeat",addressModeW:"repeat",magFilter:"linear",minFilter:"nearest",mipmapFilter:"nearest",maxAnisotropy:1})})),this.loadImageBitmap=(e,t)=>f(this,void 0,void 0,(function*(){const r={size:{width:t.width,height:t.height},format:"bgra8unorm",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT};this.texture=e.createTexture(r),i(this.texture),e.queue.copyExternalImageToTexture({source:t},{texture:this.texture},r.size)})),this.texture=null,this.view=null,this.sampler=null}}var d,l,m=function(e,t,i,r){return new(i||(i=Promise))((function(n,s){function a(e){try{u(r.next(e))}catch(e){s(e)}}function o(e){try{u(r.throw(e))}catch(e){s(e)}}function u(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(a,o)}u((r=r.apply(e,t||[])).next())}))};class p{constructor(e){this.Initialize=()=>m(this,void 0,void 0,(function*(){yield this.setupDevice(),yield this.createAssets(),yield this.makePipeline(),this.render()})),this.setupDevice=()=>m(this,void 0,void 0,(function*(){var e;this.adapter=yield null===(e=navigator.gpu)||void 0===e?void 0:e.requestAdapter(),i(this.adapter),this.device=yield this.adapter.requestDevice(),i(this.device),this.context=this.canvas.getContext("webgpu"),i(this.context),this.format="bgra8unorm",this.context.configure({device:this.device,format:this.format,alphaMode:"opaque"})})),this.createAssets=()=>m(this,void 0,void 0,(function*(){this.mesh=new n(this.device),this.material=new c,yield this.material.initialize(this.device,"dist/img/sacabambaspis.png"),this.shader=new a(this.device)})),this.makePipeline=()=>m(this,void 0,void 0,(function*(){this.uniformBuffer=this.device.createBuffer({size:192,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});const e=this.device.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX,buffer:{}},{binding:1,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:2,visibility:GPUShaderStage.FRAGMENT,sampler:{}}]});this.bindGroup=this.device.createBindGroup({layout:e,entries:[{binding:0,resource:{buffer:this.uniformBuffer}},{binding:1,resource:this.material.view},{binding:2,resource:this.material.sampler}]}),i(this.bindGroup);const t=this.device.createPipelineLayout({bindGroupLayouts:[e]});this.pipeline=this.device.createRenderPipeline({vertex:{module:this.shader.module,entryPoint:this.shader.entryPoint.Vertex,buffers:[this.shader.bufferLayout]},fragment:{module:this.shader.module,entryPoint:this.shader.entryPoint.Fragment,targets:[{format:this.format,blend:{color:{srcFactor:"src-alpha",dstFactor:"one-minus-src-alpha",operation:"add"},alpha:{srcFactor:"one",dstFactor:"one-minus-src-alpha",operation:"add"}}}]},primitive:{topology:"triangle-list"},layout:t}),i(this.pipeline)})),this.render=()=>{const e=h();!function(e,t,i,r,n){var s,a=1/Math.tan(t/2);e[0]=a/i,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=a,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=-1,e[12]=0,e[13]=0,e[15]=0,null!=n&&n!==1/0?(s=1/(r-n),e[10]=(n+r)*s,e[14]=2*n*r*s):(e[10]=-1,e[14]=-2*r)}(e,Math.PI/4,this.canvas.width/this.canvas.height,.1,10);const t=h();var i,r,n,s,a,u,f,c,d,l,m,p,v,x,g,y,b,B,P,w,_,M,T;i=t,g=(r=[0,1,-2])[0],y=r[1],b=r[2],B=(s=[0,1,0])[0],P=s[1],w=s[2],_=(n=[0,0,0])[0],M=n[1],T=n[2],Math.abs(g-_)<o&&Math.abs(y-M)<o&&Math.abs(b-T)<o?function(e){e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1}(i):(m=g-_,p=y-M,v=b-T,a=P*(v*=x=1/Math.hypot(m,p,v))-w*(p*=x),u=w*(m*=x)-B*v,f=B*p-P*m,(x=Math.hypot(a,u,f))?(a*=x=1/x,u*=x,f*=x):(a=0,u=0,f=0),c=p*f-v*u,d=v*a-m*f,l=m*u-p*a,(x=Math.hypot(c,d,l))?(c*=x=1/x,d*=x,l*=x):(c=0,d=0,l=0),i[0]=a,i[1]=c,i[2]=m,i[3]=0,i[4]=u,i[5]=d,i[6]=p,i[7]=0,i[8]=f,i[9]=l,i[10]=v,i[11]=0,i[12]=-(a*g+u*y+f*b),i[13]=-(c*g+d*y+l*b),i[14]=-(m*g+p*y+v*b),i[15]=1);const U=h();!function(e,t,i){var r,n,s,a,o,u,h,f,c,d,l,m,p=i[0],v=i[1],x=i[2];t===e?(e[12]=t[0]*p+t[4]*v+t[8]*x+t[12],e[13]=t[1]*p+t[5]*v+t[9]*x+t[13],e[14]=t[2]*p+t[6]*v+t[10]*x+t[14],e[15]=t[3]*p+t[7]*v+t[11]*x+t[15]):(r=t[0],n=t[1],s=t[2],a=t[3],o=t[4],u=t[5],h=t[6],f=t[7],c=t[8],d=t[9],l=t[10],m=t[11],e[0]=r,e[1]=n,e[2]=s,e[3]=a,e[4]=o,e[5]=u,e[6]=h,e[7]=f,e[8]=c,e[9]=d,e[10]=l,e[11]=m,e[12]=r*p+o*v+c*x+t[12],e[13]=n*p+u*v+d*x+t[13],e[14]=s*p+h*v+l*x+t[14],e[15]=a*p+f*v+m*x+t[15])}(U,U,[Math.sin(this.time),.25*Math.sin(2*this.time),0]),function(e,t,i,r){var n,s,a,u,h,f,c,d,l,m,p,v,x,g,y,b,B,P,w,_,M,T,U,C,G=r[0],F=r[1],A=r[2],I=Math.hypot(G,F,A);I<o||(G*=I=1/I,F*=I,A*=I,n=Math.sin(i),a=1-(s=Math.cos(i)),u=t[0],h=t[1],f=t[2],c=t[3],d=t[4],l=t[5],m=t[6],p=t[7],v=t[8],x=t[9],g=t[10],y=t[11],b=G*G*a+s,B=F*G*a+A*n,P=A*G*a-F*n,w=G*F*a-A*n,_=F*F*a+s,M=A*F*a+G*n,T=G*A*a+F*n,U=F*A*a-G*n,C=A*A*a+s,e[0]=u*b+d*B+v*P,e[1]=h*b+l*B+x*P,e[2]=f*b+m*B+g*P,e[3]=c*b+p*B+y*P,e[4]=u*w+d*_+v*M,e[5]=h*w+l*_+x*M,e[6]=f*w+m*_+g*M,e[7]=c*w+p*_+y*M,e[8]=u*T+d*U+v*C,e[9]=h*T+l*U+x*C,e[10]=f*T+m*U+g*C,e[11]=c*T+p*U+y*C,t!==e&&(e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]))}(U,U,6.28*(.5*Math.sin(this.time/1.9)+.5),[0,1,0]),this.device.queue.writeBuffer(this.uniformBuffer,0,U),this.device.queue.writeBuffer(this.uniformBuffer,64,t),this.device.queue.writeBuffer(this.uniformBuffer,128,e);const C=this.device.createCommandEncoder(),G={colorAttachments:[{view:this.context.getCurrentTexture().createView(),clearValue:[.5,0,.25,1],loadOp:"clear",storeOp:"store"}]},F=C.beginRenderPass(G);F.setPipeline(this.pipeline),F.setBindGroup(0,this.bindGroup),F.setVertexBuffer(0,this.mesh.vertexBuffer),F.setIndexBuffer(this.mesh.indexBuffer,this.mesh.indexFormat),F.drawIndexed(this.mesh.indexCount),F.end(),this.device.queue.submit([C.finish()]),this.time+=.01,this.time>2*Math.PI&&(this.time-=2*Math.PI),requestAnimationFrame(this.render)},this.canvas=e,this.adapter=null,this.device=null,this.context=null,this.format=null,this.uniformBuffer=null,this.bindGroup=null,this.pipeline=null,this.mesh=null,this.material=null,this.shader=null,this.time=0}}l=function*(){const e=document.getElementById("gfx-main");new p(e).Initialize()},new((d=void 0)||(d=Promise))((function(e,t){function i(e){try{n(l.next(e))}catch(e){t(e)}}function r(e){try{n(l.throw(e))}catch(e){t(e)}}function n(t){var n;t.done?e(t.value):(n=t.value,n instanceof d?n:new d((function(e){e(n)}))).then(i,r)}n((l=l.apply(void 0,[])).next())}))})();